name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  pr-checks:
    name: PR Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run linting
        id: lint
        run: |
          echo "Running ESLint..."
          bun run lint > lint-output.txt 2>&1 || echo "LINT_FAILED=true" >> $GITHUB_ENV
          cat lint-output.txt
        continue-on-error: true

      - name: Run tests with coverage
        id: test
        run: |
          echo "Running tests..."
          bun run test:coverage --json --outputFile=test-results.json > test-output.txt 2>&1 || echo "TEST_FAILED=true" >> $GITHUB_ENV
          cat test-output.txt
        continue-on-error: true

      - name: Build extension
        id: build
        run: |
          echo "Building extension..."
          bun run build > build-output.txt 2>&1 || echo "BUILD_FAILED=true" >> $GITHUB_ENV
          cat build-output.txt
        continue-on-error: true

      - name: Install Playwright browsers
        if: always()
        run: npx playwright install chromium --with-deps
        continue-on-error: true

      - name: Run E2E tests
        id: e2e
        if: always()
        run: |
          echo "Running E2E tests..."
          bun run test:e2e > e2e-output.txt 2>&1 || echo "E2E_FAILED=true" >> $GITHUB_ENV
          cat e2e-output.txt
        continue-on-error: true

      - name: Parse test results
        if: always()
        id: parse-tests
        run: |
          if [ -f test-output.txt ]; then
            TESTS_PASSED=$(grep -o "[0-9]\+ passed" test-output.txt | head -1 | grep -o "[0-9]\+" || echo "0")
            TESTS_FAILED=$(grep -o "[0-9]\+ failed" test-output.txt | head -1 | grep -o "[0-9]\+" || echo "0")
            echo "TESTS_PASSED=$TESTS_PASSED" >> $GITHUB_ENV
            echo "TESTS_FAILED=$TESTS_FAILED" >> $GITHUB_ENV
          fi
          if [ -f e2e-output.txt ]; then
            E2E_PASSED=$(grep -o "[0-9]\+ passed" e2e-output.txt | tail -1 | grep -o "[0-9]\+" || echo "0")
            E2E_FAILED=$(grep -o "[0-9]\+ failed" e2e-output.txt | tail -1 | grep -o "[0-9]\+" || echo "0")
            echo "E2E_PASSED=$E2E_PASSED" >> $GITHUB_ENV
            echo "E2E_FAILED=$E2E_FAILED" >> $GITHUB_ENV
          fi

      - name: Create PR comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const lintFailed = process.env.LINT_FAILED === 'true';
            const testFailed = process.env.TEST_FAILED === 'true';
            const buildFailed = process.env.BUILD_FAILED === 'true';
            const e2eFailed = process.env.E2E_FAILED === 'true';
            const testsPassed = process.env.TESTS_PASSED || '0';
            const testsFailed = process.env.TESTS_FAILED || '0';
            const e2ePassed = process.env.E2E_PASSED || '0';
            const e2eFailed = process.env.E2E_FAILED || '0';

            let status = '‚úÖ All checks passed!';
            let color = 'üü¢';

            if (lintFailed || testFailed || buildFailed || e2eFailed) {
              status = '‚ùå Some checks failed';
              color = 'üî¥';
            }

            const comment = `## ${color} PR Quality Report

            ### Status: ${status}

            | Check | Status |
            |-------|--------|
            | üîç Linting | ${lintFailed ? '‚ùå Failed' : '‚úÖ Passed'} |
            | üß™ Unit Tests | ${testFailed ? `‚ùå Failed (${testsFailed} failed, ${testsPassed} passed)` : `‚úÖ Passed (${testsPassed} tests)`} |
            | üé≠ E2E Tests | ${e2eFailed ? `‚ùå Failed (${e2eFailed} failed, ${e2ePassed} passed)` : `‚úÖ Passed (${e2ePassed} tests)`} |
            | üì¶ Build | ${buildFailed ? '‚ùå Failed' : '‚úÖ Passed'} |

            ${lintFailed || testFailed || buildFailed || e2eFailed ? '‚ö†Ô∏è **Please fix the failing checks before merging.**' : '‚ú® **Ready to merge!**'}

            ---
            <sub>Generated by GitHub Actions</sub>
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('PR Quality Report')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Fail if checks failed
        if: always()
        run: |
          if [ "${{ env.LINT_FAILED }}" = "true" ] || \
             [ "${{ env.TEST_FAILED }}" = "true" ] || \
             [ "${{ env.BUILD_FAILED }}" = "true" ] || \
             [ "${{ env.E2E_FAILED }}" = "true" ]; then
            echo "‚ùå One or more checks failed"
            exit 1
          fi
          echo "‚úÖ All checks passed!"
